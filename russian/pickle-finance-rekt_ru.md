---
title: Pickle Finance - REKT
slug: pickle-finance-rekt
date: 22 ноября 2020
rekt: 
  количество: 19700000
  аудит: MixBytes, Haechi
  дата: 22 ноября 2020
tags:
  - pickle finance
  - Rekt
excerpt: Брожение в финансах продолжается. Даже у соленых огурцов есть срок годности. Pickle Finance стал новой жертвой эпидемии хакерских атак. Но в этот раз все было не как обычно...
banner: https://raw.githubusercontent.com/RektHQ/Assets/main/images/2020/11/rr.jpeg
---

![](https://raw.githubusercontent.com/RektHQ/Assets/main/images/2020/11/rr.jpeg)

**Брожение в финансах продолжается. Даже у соленых огурцов есть срок годности.**

Хранилище, в котором хранились токены [cDAI](https://github.com/pickle-finance/contracts#pickle-jars-pjars) протокола Pickle Finance подверглось [хакерской атаке](https://bloxy.info/tx/0xe72d4e7ba9b5af0cf2a8cfb1e30fd9f388df0ab3da79790be842bfbed11087b0) через уязвимость с использованием фальшивых «Pickle Jars» (банок с огурцами - прим. переводчика). Было украдено 19.7 миллионов DAI.

Pickle Finance стал новой жертвой [эпидемии хакерских атак.](/hack-epidemic/)

**Но в этот раз все было не как обычно...**

Пока в Твиттере пытались смириться с очередной финансовой катастрофой, Rekt начал проводить расследование.

Мы связались с командой Stake Capital, они просмотрели код и предупредили, что и другие банки могли оказаться под угрозой.

Тогда мы быстро связались с командой Pickle Finance и организовали командный пункт с участниками Stake Capital (@[bneiluj](https://twitter.com/bneiluj), [@vasa_develop](https://twitter.com/vasa_develop))  Yearn ([@bantg](https://twitter.com/bantg)) [Pickle Finance](https://twitter.com/picklefinance) и опытными разработчиками @[samczsun](https://twitter.com/samczsun), [@emilianobonassi](https://twitter.com/emilianobonassi).

В ходе работы стало ясно, что перед нами было что-то совершенно отличающееся от DeFi-атак в стиле лего, происходивших последние недели.

**Это была не арбитражная атака.**

Атакующий обладал отличным знанием Solidify и EVM и, похоже, какое-то время очень пристально наблюдал за кодом Yearn, потому что уязвимость была похожа на ту, что была [обнаружена](https://github.com/iearn-finance/yearn-security/blob/master/disclosures/2020-10-10.md) в коде Yearn месяцем ранее.

Pickle Jars это по сути своей форки yVault протокола Yearn. Jars контролируются контрактом под названием Controller. У него есть функция, которая позволяет пользователям обменивать активы между Jars.

К сожалению, нет белого списка Jars, у которых есть разрешение на использование этой функции обмена.

Хакер создал фальшивый Pickle Jar и обменял фонды с оригинальной банкой. Это стало возможным, потому что [swapExactJarForJar](https://twitter.com/emilianobonassi/status/1330239233538318339?s=20) не проверил, была ли эта "банка" в «белом списке».

Команда Pickle Finance знала, что им нужна помощь, поэтому они с радостью согласились принять помощь со стороны, чтобы избежать еще больших повреждений.

Pickle попробовали вызвать “withdrawAll”, но транзакция [не прошла](https://etherscan.io/tx/0xb108205dc90466104f10d3e465593825ea88420cd8db6df29afd57e62df5cba6).

Запрос на вывод должен был пройти через ДАО Управления, на которой был установлен 12-часовой таймер.

Только один из членов мультисига Pickle мог обойти таймер, но он спал.

Это значило, что админы не могли опустошить Pickle Jars, но это не защитило их от атаки с другой стороны.

[Pickle Finance](https://twitter.com/picklefinance/status/1330256787002564610?s=20) и [Curve](https://twitter.com/bneiluj/status/1330255575339438088?s=20) послали пользователям предупреждения о том, что им нужно было немедленно вывести фонды из Pickle. Но все же $50 миллионов еще оставались в потенциально уязвимых pickle jars, пока команда белых шляп расследовала эксплоит и проверяла, в безопасности ли оставшиеся фонды.

Спасательному отряду нужно было либо разбудить спящего админа, либо самим слить банки.

![](https://lh5.googleusercontent.com/iBloOUNiyzcS6t7vuiT8Ric31fzGktin3XSZ53MAGk0eJiylu53vsQJ_BdPOHba_7yH81037JWZX_H48bzbwH5AoNMn3jFz8Q_YplF9Xk8sm47IHRK07RnTIB8I8Ebeba4vJCCJp)

**Команде пришлось преодолеть пять главных трудностей.**

1. Собрать вместе всю команду Pickle Finance, учитывая, что они находятся в разных часовых поясах. Начать спасать фонды, отправляя транзакции в 12-часовой таймер (через 3 из 6 мультисигов), чтобы вывести все фонды.  

2. Заставить тысячи инвесторов вывести свои фонды (и уговорить их не вкладывать снова, когда TLV хранилища упадет и APY раздуется до 1000+% годовых)

3. Провести проверку безопасности в других банках, чтобы выявить возможность новых атак.

4. Продублировать атаку в превентивных целях до того, как кто-то сможет снова взломать банки.

5. Избежать фронтраннинг во время попытки спасти оставшиеся 50К.

**Как долго еще мы можем полагаться на помощь псевдо-анонимных этичных хакеров?**

Стимулы явно больше ориентированы на злоумышленников, чем на защитников; зачем им координировать такую изнурительную контратаку?

Слава достается этичным контратакам, а деньги идут хакерам. **Так не может долго продолжаться.** 

Сколько еще осталось ждать, когда искушение покрасит белые шляпы в черный цвет?

**Анализ**

Публикуя эту информацию технического содержания мы осознаем, что это может спровоцировать новые хакерские атаки. Мы обсудили возможные последствия с Pickle Finance и другими разработчиками и пришли к выводу, что нам неизвестно о каких-либо других действующих форках Pickle, которые могли бы подвергнуться копипастным атакам.

Выборочное раскрытие информации означало бы взять на себя определенную степень ответственности, поэтому мы предпочли свободную публикацию. Если какой-либо протокол использует форк кода Pickle, то они уже скорее всего в курсе разворачивающихся событий и принимают предупредительные меры против копипастных атак.

Следующую схему создал [@vasa_develop](https://twitter.com/vasa_develop).

![](https://raw.githubusercontent.com/RektHQ/Assets/main/images/2020/11/Pickle-Exploit-Overview.png)

Оригинальный файл можно найти [здесь](https://lucid.app/lucidspark/invitations/accept/8f291e25-bf50-4a77-913d-31ddfb62754b).

**Подробное описание можно найти в полном постмортеме, сделанном командой, [здесь](https://github.com/banteg/evil-jar/blob/master/readme.md).**

Интересно будет посмотреть, как относительно новый страховой примитив “[Cover Protocol](https://twitter.com/CoverProtocol/status/1330238732558098437?s=20)” справится с инцидентом; речь идет о немалой сумме денег для первого запроса компенсации. Обзор голосования по заявке на страховое возмещение можно найти [здесь.](https://snapshot.page/#/cover/proposal/QmPSkV68ihhP8EAZbNoQVsTpUh82wiX18ckyEwiUbChRjQ)

![](https://lh5.googleusercontent.com/HcyTLZyj6aAciaM5wFLPJl04zSx8n_iqwYnnetTg_ATBVappkijm1K2TtSjkbAAwsDNFcJCaiz1uibep5WAC4-56uyMRDn8p5jk-iLHk53qklgC1Jc_4JiOZrLkr3jZ-ictipp2N)

**Маринование это долгий процесс.**

Десятилетиями пропагандисты гибкой разработки подгоняли разработчиков, чтобы те быстро провалились и выпустили продукт с минимальной жизнеспособностью. Эти идеи не совсем подходят разработке, которая ведется в условиях враждебной среды.

**В DeFi быстро провалиться стоит очень дорого.**

Нам не просто нужна новая методология. Нам нужна смена парадигмы, которая позволит проводить быструю итерацию и одновременно снизит вероятность попадания под rekt.  

Давайте избавимся от мысли, что аудит может гарантировать безопасность. В большинстве случаев это обзор по пунктам мер безопасности, которые применяются к движущимся целям, и которые часто вырастают во что-то другое спустя небольшой промежуток времени после выхода проекта в главную сеть.

Аудиты, выполненные MixBytes (3 октября) и Haechi (20 октября) были завершены до добавления ControllerV4 (23 октября), который стал одним из ключевых векторов атаки.

**В будущем финансов самыми лучшими станут те команды, которые смогут находить компромисс между необходимостью выпустить продукт быстро и выпустить его безопасно.** Для этого им придется постоянно проводить аудиты и тщательно тестировать свои сборные денежные роботы на постоянной основе.

Аудит должен быть регулярным и постоянным процессом, а не клеточкой, в которой нужно поставить галочку перед запуском. Новые DeFi-протоколы постоянно меняются и приспосабливаются, и аудиты по безопасности должны это отражать.

**Огурцы остаются свежими только тогда, когда они хранятся в банке...**

![](https://lh6.googleusercontent.com/Bx_HYNlFKOcaH6XtCcUCcE5TlykgAkp3vka10Tq1KkOV_bK4YxOtjJTcUt73XhYoauO3_I9SQeu55sTKkjAj0brsKfis-lPGuRpPth03tGxuxEF46oU5lJm_mgvkIL1ro_AYZh6F)

Фото @[martinkrung ](https://twitter.com/martinkrung)
